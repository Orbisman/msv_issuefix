<?xml version="1.0"?>
<!--
	Ant script for running a batch test that uses "testCases"
-->
<project>
	
	<!-- import the global configuration file -->
	<property file="../shared/ant.config"/>
	
	
	<!-- test directory where you put your files like "relaxNNN.rlx" -->
	<property name="testRoot" value="../testCases" />
	
	<!-- test configuration -->
	<path id="commonTestDir">
		<pathelement path="${testRoot}/suites/JepaX"/>
		<pathelement path="${testRoot}/suites/NITF"/>
		<pathelement path="${testRoot}/suites/errorRELAXGrammar/lrgErrRatio"/>
		<pathelement path="${testRoot}/errorRELAXGrammar/smlErrRatio" />
	</path>
	
	<path id="RELAXBatchTestDir">
		<path refid="commonTestDir"/>
		<pathelement path="${testRoot}/relax"/>
	</path>
	<property name="RELAXBatchTestDir" refid="RELAXBatchTestDir"/>
	
	<path id="RELAXNGBatchTestDir">
		<path refid="commonTestDir"/>
		<pathelement path="${testRoot}/relaxng"/>
	</path>
	<property name="RELAXNGBatchTestDir" refid="RELAXNGBatchTestDir"/>
	
	<path id="TREXBatchTestDir">
		<path refid="commonTestDir"/>
		<pathelement path="${testRoot}/trex"/>
	</path>
	<property name="TREXBatchTestDir" refid="TREXBatchTestDir"/>
	
	<path id="DTDBatchTestDir">
		<path refid="commonTestDir"/>
		<pathelement path="${testRoot}/DTD/XHTMLm12n/examples"/>
		<pathelement path="${testRoot}/DTD/XHTML1.0"/>
	</path>
	<property name="DTDBatchTestDir" refid="DTDBatchTestDir"/>
	
	<path id="XSDBatchTestDir">
		<path refid="commonTestDir"/>
		<pathelement path="${testRoot}/xmlschema"/>
		<pathelement path="${testRoot}/xmlschema/tutorialExamples"/>
		<pathelement path="${testRoot}/xmlschema/identity" />
	</path>
	<property name="XSDBatchTestDir" refid="XSDBatchTestDir"/>
	
	
	
	
	
<!--
	PatternSets for the partial test
	========================================================================
	
	This pattern specifies which test codes should be executed.
	The same pattern is used to test both the working copy and the release package.
-->
	<!-- all -->
	<patternset id="tps.all">
		<include name="**/*Test.class"/>
		<include name="**/*TestG.class"/>
	</patternset>
	
	<!-- XSDLib -->
	<patternset id="tps.xsdlib">
		<include name="com/sun/msv/datatype/**/*Test.class" />
	</patternset>
	
	<!-- MSV core -->
	<patternset id="tps.msv">
		<include name="batch/verifier/**/*Test.class" />
		<include name="com/sun/msv/util/*Test.class" />
	</patternset>
	
	<!-- generator -->
	<patternset id="tps.generator">
		<include name="**/generator/**/*TestG.class" />
	</patternset>
	
	<!--  RELAX converter -->
	<patternset id="tps.rngconv">
		<include name="batch/writer/relaxng/**/*Test.class"/>
	</patternset>
	
	<!-- TREX converter -->
	<patternset id="tps.trexconv">
		<include name="batch/writer/trex/**/*Test.class"/>
	</patternset>
	
	
	
	
<!--
	test tasks
	========================================================================
-->
	<!-- run all -->
	<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
	<target name="test">
		<antcall target="doTest">
			<param name="testPattern" value="tps.all"/>
		</antcall>
	</target>
	
	
	<!-- run xsdlib test                                                 -->
	<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
	<target name="test_xsdlib">
		<antcall target="doTest">
			<param name="testPattern" value="tps.xsdlib"/>
		</antcall>
	</target>
	<target name="test_xsdlib_package">
		<antcall target="doReleaseTest">
			<param name="testPattern" value="tps.xsdlib" />
			<param name="testJar" value="./package/xsdlib.jar"/>
		</antcall>
	</target>
	
	
	<!-- run core msv test                                               -->
	<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
	<target name="test_msv">
		<antcall target="doTest">
			<param name="testPattern" value="tps.msv"/>
		</antcall>
	</target>
	<target name="test_msv_package">
		<antcall target="doReleaseTest">
			<param name="testPattern" value="tps.msv" />
			<param name="testJar" value="./package/msv.jar"/>
		</antcall>
	</target>
	
	
	<!-- run generator test                                              -->
	<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
	<target name="test_xmlgen">
		<antcall target="doTest">
			<param name="testPattern" value="tps.generator" />
		</antcall>
	</target>
	<target name="test_xmlgen_package">
		<antcall target="doReleaseTest">
			<param name="testPattern" value="tps.generator" />
			<param name="testJar" value="./package/xmlgen.jar"/>
		</antcall>
	</target>
	
	
	<!-- run RELAX NG converter test                                     -->
	<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
	<target name="test_rngconv">
		<antcall target="doTest">
			<param name="testPattern" value="tps.rngconv" />
		</antcall>
	</target>
	<target name="test_rngconv_package">
		<antcall target="doReleaseTest">
			<param name="testPattern" value="tps.rngconv" />
			<param name="testJar" value="./package/rngconv.jar"/>
		</antcall>
	</target>
	
	
	<!-- run TREX converter test                                         -->
	<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
	<target name="test_trexconv">
		<antcall target="doTest">
			<param name="testPattern" value="tps.trexconv" />
		</antcall>
	</target>
	<target name="test_trexconv_package">
		<antcall target="doReleaseTest">
			<param name="testPattern" value="tps.trexconv" />
			<param name="testJar" value="./package/trexconv.jar"/>
		</antcall>
	</target>
	
	
	
	
	
	
	
	
	<!-- internal test task                                              -->
	<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
		<!--
			test the current working copy
			=============================
			
			required parameters to call:
				${testPattern}	ID of the pattern set to be used to filter the test case.
		-->
		<target name="doTest">
			<mkdir dir="./testLog" />
			<!--
				please remove jaxp.jar from ant directory,
				because it uses an old one, and this test needs the latest one
			-->
			<junit haltonfailure="yes" printsummary="yes" fork="yes"
				haltonerror="yes">
				<sysproperty key="RELAXBatchTestDir"	value="${RELAXBatchTestDir}"/>
				<sysproperty key="TREXBatchTestDir"		value="${TREXBatchTestDir}"/>
				<sysproperty key="DTDBatchTestDir"		value="${DTDBatchTestDir}"/>
				<sysproperty key="XSDBatchTestDir"		value="${XSDBatchTestDir}"/>
				<sysproperty key="RELAXNGBatchTestDir"	value="${RELAXNGBatchTestDir}"/>
				
 				<formatter type="plain" />
				
				<classpath>
					<pathelement location="bin" />
					<pathelement location="src" />
					<pathelement location="test" />
					<pathelement location="${relaxng.jar}" />
					<pathelement path="${java.class.path}" />
					<!--include CatalogManager.properties into the class path -->
					<pathelement path="${testRoot}"/>
				</classpath>
				
				<batchtest todir="./testLog">
					<fileset dir="bin">
						<include name="**/*Test.class"/>
					</fileset>
				</batchtest>
			</junit>
		</target>
		
		
		
		
		
		<!--
			test the release package
			========================
			
			required parameters to call:
				${testJar}		jar file to be tested. (e.g., msv.jar or xmlgen.jar)
				${testPattern}	ID of the pattern set to be used to filter the test case.
		-->
		<target name="doReleaseTest">
			
			<!-- create temporary directory -->
			<mkdir dir="./temp"/>
			
			<!-- extract the contents of the jar file to be tested -->
			<unjar src="${testJar}" dest="temp" />
			
			<!--
				compile test harnesses into it.
				It is ok to rely on the working copy at this stage.
			-->
			<javac
				srcdir="${testDir}"
				destdir="./temp"
				debug="on"
				optimize="off"
				classpath="temp:bind"
				/>
			
			<!-- run JUnit -->
			<mkdir dir="./testLog" />
			<junit haltonfailure="yes" printsummary="yes" fork="yes"
				haltonerror="yes">
				<sysproperty key="RELAXBatchTestDir"	value="${RELAXBatchTestDir}"/>
				<sysproperty key="TREXBatchTestDir"		value="${TREXBatchTestDir}"/>
				<sysproperty key="DTDBatchTestDir"		value="${DTDBatchTestDir}"/>
				<sysproperty key="XSDBatchTestDir"		value="${XSDBatchTestDir}"/>
				<sysproperty key="RELAXNGBatchTestDir"	value="${RELAXNGBatchTestDir}"/>
				
  				<formatter type="plain" />
				
				<classpath>
					<!-- do not refer to the working copy -->
					<pathelement location="${testDir}" />
					<pathelement location="./temp" />
					<pathelement location="${JUnitJar}"/>
					<pathelement location="${AntJar}"/>
					<!-- do not let whatever binaries in your classpath interfer with it. -->
				<!-- DO NOT: <pathelement path="${java.class.path}" />-->
				</classpath>
				
				<batchtest todir="./testLog">
					<fileset dir="temp">
						<patternset refid="${testPattern}"/>
					</fileset>
				</batchtest>
			</junit>
			
			<delete dir="./temp"/>
		</target>
	
</project>