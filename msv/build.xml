<?xml version="1.0"?>

<project name="tranquilo" basedir="." default="jars">
	<property name="sourceDir" value="./src"/>
	<property name="testDir" value="./test"/>
	<property name="buildDir" value="./build"/>
	<property name="documentDir" value="./doc/javadoc"/>
	<property name="packageDir" value="./package"/>
	<property name="libDir" value="./lib"/>
	<property name="javaCClib" value="C:\Progra~1\Development\JavaCC\bin\lib" />
	<property name="cvsRoot" value=":local:/cygdrive/c/Program Files/Development/CVS Repository" />
	
	<!-- test directory where you put your files like "relaxNNN.rlx" -->
	<property name="RELAXBatchTestDir" value="C:/work/relax;c:/work/NITF;c:/work/JepaX" />
	<property name="TREXBatchTestDir" value="C:/work/trex;c:/work/NITF;c:/work/JepaX" />


	
	<!-- compile Java source files -->
	<target name="binary" depends="javacc">
		<javac srcdir="${sourceDir}" destdir="${buildDir}"/>
	</target>
	
	
		<!-- internal task -->
		<target name="doJavacc">
			<javacc	target="${src}/com/sun/tranquilo/datatype/datetime/ISO8601.jj"
					outputdirectory="${src}/com/sun/tranquilo/datatype/datetime"
					javacchome="${javaCClib}"
			/>

			<!-- run javacc for UriReference -->
			<javacc	target="${src}/com/sun/tranquilo/datatype/anyURI.jj"
					outputdirectory="${src}/com/sun/tranquilo/datatype"
					javacchome="${javaCClib}"
			/>
		</target>
	
	<!-- run javacc -->
	<target name="javacc">
		<!-- run javacc -->
		<antcall target="doJavacc">
			<param name="src" value="${sourceDir}" />
		</antcall>
	</target>

	
	
	
	<!--  run all the test suites -->
	<target name="test">
		<mkdir dir="./testLog" />
		<!--
			please remove jaxp.jar from ant directory,
			because it uses an old one, and this test needs the latest one
		-->
		<junit haltonfailure="yes" printsummary="yes" fork="yes">
			<sysproperty key="RELAXBatchTestDir"	value="${RELAXBatchTestDir}"/>
			<sysproperty key="TREXBatchTestDir"		value="${TREXBatchTestDir}"/>
			
  			<formatter type="plain" />
			
			<classpath>
				<pathelement location="${buildDir}" />
				<pathelement location="${sourceDir}" />
				<pathelement location="${testDir}" />
				<pathelement location="lib/dispatcher" />
				<pathelement path="${java.class.path}" />
			</classpath>
		
			<batchtest todir="./testLog">
				<fileset dir="${buildDir}">
					<include name="**/*Test.class" />
				</fileset>
			</batchtest>
		</junit>
	</target>
	
	
	
	<!-- generate jar files -->
	<target name="jars" depends="binary">
		<tstamp />
		
		<!-- standard archive -->
		<jar	jarfile="${packageDir}/tranquilo.${DSTAMP}.jar"
				manifest="./META-INF/MANIFEST.MF"
				compress="false">
			<fileset dir="${sourceDir}" includes="**/*.properties" />
			<fileset dir="${buildDir}" includes="**/*.class" />
			<fileset dir="${libDir}" includes="**/*.class" />
			<fileset dir="c:/winnt/java/classes" includes="org/apache/**/*, org/xml/**/*, org/w3c/**/*" />
		</jar>
	</target>
	
	<!-- generate javadoc documentation -->
	<target name="javadoc">
		<javadoc	locale="en_US"
					packagenames="com.sun.tranquilo.*"
					sourcepath="${sourceDir}"
					classpath="lib/dispatcher;${java.class.path}"
					destdir="${documentDir}"
					windowtitle="Tranquilo RELAX/TREX Verifier"
					public="yes"
					>
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api" packagelistLoc="ExternalPackageLists\CoreAPI" />
			<link offline="true" href="http://xml.apache.org/apiDocs/" packagelistLoc="ExternalPackageLists\XML" />
			<link offline="true" href="http://iso-relax.sourceforge.net/apiDoc/" packagelistLoc="ExternalPackageLists\ISO-RELAX" />
		</javadoc>
	</target>
	
	
	
	
	
<!--
	release task
	************************************************
-->
	
	<!-- generate XSDLib release -->
	<target name="xsd">
		<tstamp />
		<property name="stageName" value="xsdlib-${DSTAMP}"/>
		
		<delete	dir="${stageName}" />
		<mkdir	dir="${stageName}" />
		<mkdir	dir="${stageName}/src" />
		<mkdir	dir="${stageName}/src/com/sun/tranquilo/datatype" />
		<mkdir	dir="${stageName}/src/com/sun/xml" />
		
		<!-- obtain source codes from cvs -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/test/com/sun/tranquilo/datatype/CommandLineTester.java"
				command="export -d . -D now"
				dest="${stageName}/src/com/sun/tranquilo/datatype" />
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/src/com/sun/tranquilo/datatype"
				command="export -d . -D now"
				dest="${stageName}/src/com/sun/tranquilo/datatype" />
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/src/com/sun/xml"
				command="export -d . -D now"
				dest="${stageName}/src/com/sun/xml" />

		<!-- copy Xerces files into source directory -->
		<copy todir="${stageName}/src">
			<fileset dir="C:\Program Files\Development\Xerces\src" includes="org/apache/xerces/utils/regex/*.*" />
		</copy>
		
		<!-- obtain document files -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/doc/datatype"
				command="export -d . -D now"
				dest="${stageName}" />
				
		<!-- run javacc -->
		<antcall target="doJavacc">
			<param name="src" value="${stageName}/src" />
		</antcall>
		
		
		<!-- compile files -->
		<mkdir	dir="temp" />
		<javac	srcdir="${stageName}/src"
				destdir="temp">
			<include name="**/*.java" />
		</javac>
		
		<!-- create a time stamp file -->
		<echo file="temp/version.properties">version=${DSTAMP}</echo>
		
		<!-- creates binary jar -->
		<jar	jarfile="${stageName}/xsdlib.jar"
				manifest="./META-INF/XSD.MANIFEST.MF"
				compress="false">
			<fileset dir="temp" />
		</jar>
		<delete dir="temp" />
		
		
		<!-- creates javadoc -->
		<mkdir		dir="${stageName}/javadoc" />
		<javadoc	locale="en_US"
					packagenames="com.sun.tranquilo.datatype.*"
					sourcepath="${stageName}/src"
					destdir="${stageName}/javadoc"
					windowtitle="XML Schema Part 2 Implementation"
					public="yes"
					>
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api" packagelistLoc="ExternalPackageLists\CoreAPI" />
			<link offline="true" href="http://xml.apache.org/apiDocs/" packagelistLoc="ExternalPackageLists\XML" />
		</javadoc>

		<!-- delete the source! -->		
		<delete>
			<fileset dir="${stageName}/src" excludes="**/CommandLineTester.java" />
		</delete>

		<!-- creates distribution package -->
		<zip	zipfile="${packageDir}/xsdlib.${DSTAMP}.zip"
				basedir="."
				includes="${stageName}/**/*.*" />
		
		<delete	dir="${stageName}" />
	</target>
	
	
	<!-- generate Tranquilo release -->
	<target name="release">
		<tstamp />
		<property name="stageName" value="tranquilo-${DSTAMP}" />
		
		<delete	dir="${stageName}" />
		<mkdir	dir="${stageName}" />
		<mkdir	dir="${stageName}/src" />

		<!-- obtain source codes from cvs -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/src"
				command="export -d . -D now"
				dest="${stageName}/src/" />
		
		<!-- obtain document files -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/doc/tranquilo"
				command="export -d . -D now"
				dest="${stageName}" />
	
		<!-- run javacc -->
		<antcall target="doJavacc">
			<param name="src" value="${stageName}/src" />
		</antcall>
		
		<!-- unzip contents from iso-relax.jar into binary directory -->
		<!-- for ease of use, iso-relax.jar is merged into tranquilo.jar -->
		<unjar src="${libDir}/iso-relax.jar" dest="temp" />
		
		<!-- compile files -->
		<mkdir	dir="temp" />
		<javac	srcdir="${stageName}/src"
				destdir="temp"
				classpath="temp;${java.class.path}">
			<include name="**/*.java" />
		</javac>
		
		<!-- unzip contents from xerces.jar -->
		<mkdir dir="xerces" />
		<unjar src="c:\winnt\java\classes\xerces.jar" dest="xerces" />
		
		<!-- create a time stamp file -->
		<echo file="temp/version.properties">version=${DSTAMP}</echo>
		
		<!-- creates binary jar -->
		<jar	jarfile="${stageName}/tranquilo.jar"
				manifest="./META-INF/MANIFEST.MF"
				compress="false">
			<fileset dir="${stageName}/src" includes="**/tranquilo/**/*.properties" />
			<fileset dir="${libDir}" includes="javax/xml/parsers/*.class" />
			<fileset dir="temp" />
			<fileset dir="xerces" includes="org/apache/xerces/**/*.*" />
<!--			<fileset dir="c:\winnt\java\classes" includes="org/apache/xerces/utils/regex/*.*" />	-->
			<fileset dir="c:\winnt\java\classes" includes="org/xml/sax/**/*.class org/w3c/dom/**/*.class" />
		</jar>
		
		<!-- creates javadoc -->
		<mkdir		dir="${stageName}/javadoc" />
		<javadoc	locale="en_US"
					packagenames="com.sun.tranquilo.*"
					sourcepath="${stageName}/src"
					classpath="temp;${java.class.path}"
					destdir="${stageName}/javadoc"
					windowtitle="Tranquilo Verifier"
					public="yes"
					>
			<!--
				if you have encountered error around here,
				please remove all offline="true" and packagelistLoc="...".
			-->
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api" packagelistLoc="ExternalPackageLists\CoreAPI" />
			<link offline="true" href="http://xml.apache.org/apiDocs/" packagelistLoc="ExternalPackageLists\XML" />
			<link offline="true" href="http://iso-relax.sourceforge.net/apiDoc/" packagelistLoc="ExternalPackageLists\ISO-RELAX" />
		</javadoc>

		<delete dir="temp" />
		<delete dir="xerces" />
		
		
		<!-- creates distribution package -->
		<zip	zipfile="${packageDir}/tranquilo.${DSTAMP}.zip"
				basedir="."
				includes="${stageName}/**/*.*" />
		
		<delete dir="${stageName}" />
	</target>
	
	
	
	
	
	
	
	<!-- generator release -->
	<target name="generator">
		<tstamp />
		<property name="stageName" value="tranqgen-${DSTAMP}"/>
		
		<delete	dir="${stageName}" />
		<mkdir	dir="${stageName}" />
		<mkdir	dir="${stageName}/src" />
		
		<!-- obtain source codes from cvs -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/generator"
				command="export -d . -D now"
				dest="${stageName}/src" />
				
		<!-- obtain document files -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/doc/generator"
				command="export -d . -D now"
				dest="${stageName}" />
		
		
		<!-- compile files -->
		<mkdir	dir="temp" />
		<javac	srcdir="${stageName}/src"
				destdir="temp"
				classpath="./package/tranquilo.jar">
			<include name="**/*.java" />
		</javac>
		
		<!-- create a time stamp file -->
		<echo file="temp/version.properties">version=${DSTAMP}</echo>
		
		<!-- creates binary jar -->
		<jar	jarfile="${stageName}/tranqgen.jar"
				manifest="./META-INF/Generator.MANIFEST.MF"
				compress="false">
			<fileset dir="temp" includes="**/*.*" />
		</jar>
		<delete dir="temp" />
		
		
		<!-- creates javadoc -->
		<mkdir		dir="${stageName}/javadoc" />
		<javadoc	locale="en_US"
					packagenames="com.sun.tranquilo.generator.*"
					sourcepath="${stageName}/src"
					destdir="${stageName}/javadoc"
					windowtitle="Tranquilo Generator"
					public="yes"
					>
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api" packagelistLoc="ExternalPackageLists\CoreAPI" />
			<link offline="true" href="http://xml.apache.org/apiDocs/" packagelistLoc="ExternalPackageLists\XML" />
		</javadoc>
		
		<!-- creates distribution package -->
		<zip	zipfile="${packageDir}/tranqgen.${DSTAMP}.zip"
				basedir="."
				includes="${stageName}/**/*.*" />
		
		<delete	dir="${stageName}" />
	</target>
</project>
