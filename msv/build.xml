<?xml version="1.0"?>

<project name="tranquilo" basedir="." default="jars">
	<property name="sourceDir" value="./src"/>
	<property name="testDir" value="./test"/>
	<property name="buildDir" value="./build"/>
	<property name="documentDir" value="./doc/javadoc"/>
	<property name="packageDir" value="./package"/>
	<property name="libDir" value="./lib"/>
	<property name="javaCClib" value="./ref/javacc/bin/lib" />
	<property name="cvsRoot" value=":local:/cygdrive/c/Program Files/Development/CVS Repository" />
	<property name="cvsExportOpt" value="-D now" />	<!-- -r branch -->
	
	<!-- test directory where you put your files like "relaxNNN.rlx" -->
	<property name="testRoot" value="./testCases" />
	<property name="commonTestDir" value="${testRoot}/suites/JepaX;${testRoot}/suites/NITF;${testRoot}/suites/errorRELAXGrammar/lrgErrRatio;${testRoot}/errorRELAXGrammar/smlErrRatio" />
	<property name="RELAXBatchTestDir" value="${testRoot}/relax;${commonTestDir}" />
	<property name="RELAXNGBatchTestDir" value="${testRoot}/relaxng;${commonTestDir}" />
	<property name="TREXBatchTestDir" value="${testRoot}/trex;${commonTestDir}" />
	<property name="DTDBatchTestDir" value="${commonTestDir}" />
	<property name="XSDBatchTestDir"
		value="${testRoot}/xmlschema;${testRoot}/xmlschema/tutorialExamples;${commonTestDir};${testRoot}/xmlschema/identity" />


	
	<!-- compile Java source files -->
	<target name="binary" depends="javacc">
		<javac
			srcdir="${sourceDir}:${testDir}:lib\dispatcher"
			destdir="${buildDir}"
			debug="on"
			optimize="off"
			classpath="lib"
			/>
	</target>
	
	
		<!-- internal task -->
		<target name="doJavacc">
			<javacc	target="${src}/com/sun/msv/datatype/datetime/ISO8601.jj"
					outputdirectory="${src}/com/sun/msv/datatype/datetime"
					javacchome="${javaCClib}"
			/>

			<!-- run javacc for UriReference -->
<!--
			<javacc	target="${src}/com/sun/msv/datatype/anyURI.jj"
					outputdirectory="${src}/com/sun/msv/datatype"
					javacchome="${javaCClib}"
			/>
-->
		</target>
	
	<!-- run javacc -->
	<target name="javacc">
		<!-- run javacc -->
		<antcall target="doJavacc">
			<param name="src" value="${sourceDir}" />
		</antcall>
	</target>

	
	
	
	<!--  run all the test suites -->
	<target name="test">
		<antcall target="doTest">
			<param name="testClasses" value="**/*Test.class" />
			<param name="testClasses" value="**/*TestG.class" />
		</antcall>
	</target>
	
	<!-- run msv test suites -->
	<target name="test_msv">
		<antcall target="doTest">
			<param name="testClasses" value="batch/verifier/*Test.class" />
		</antcall>
		<antcall target="doTest">
			<param name="testClasses" value="com/sun/msv/datatype/*Test.class" />
		</antcall>
		<antcall target="doTest">
			<param name="testClasses" value="com/sun/msv/util/*Test.class" />
		</antcall>
	</target>
	
	<!--  run generator test suites -->
	<target name="test_generator">
		<antcall target="doTest">
			<param name="testClasses" value="**/generator/**/*TestG.class" />
		</antcall>
	</target>
	
	<!--  run writer test suites -->
	<target name="test_writer">
		<antcall target="doTest">
			<param name="testClasses" value="batch/writer/**/*Test.class" />
		</antcall>
	</target>
	
	
		<!-- internal task -->
		<target name="doTest">
			<mkdir dir="./testLog" />
			<!--
				please remove jaxp.jar from ant directory,
				because it uses an old one, and this test needs the latest one
			-->
			<junit haltonfailure="yes" printsummary="yes" fork="yes"
				haltonerror="yes">
				<sysproperty key="RELAXBatchTestDir"	value="${RELAXBatchTestDir}"/>
				<sysproperty key="TREXBatchTestDir"		value="${TREXBatchTestDir}"/>
				<sysproperty key="DTDBatchTestDir"		value="${DTDBatchTestDir}"/>
				<sysproperty key="XSDBatchTestDir"		value="${XSDBatchTestDir}"/>
				<sysproperty key="RELAXNGBatchTestDir"	value="${RELAXNGBatchTestDir}"/>
				
  				<formatter type="plain" />
				
				<classpath>
					<pathelement location="${buildDir}" />
					<pathelement location="${sourceDir}" />
					<pathelement location="${testDir}" />
					<pathelement location="lib/dispatcher" />
					<pathelement path="${java.class.path}" />
				</classpath>
			
				<batchtest todir="./testLog">
					<fileset dir="${buildDir}">
						<include name="${testClasses}" />
					</fileset>
				</batchtest>
			</junit>
		</target>
	
	
	
	<!-- generate jar files -->
	<target name="jars" depends="binary">
		<tstamp />
		
		<!-- standard archive -->
		<jar	jarfile="${packageDir}/msv.${DSTAMP}.jar"
				manifest="./META-INF/MANIFEST.MF"
				compress="false">
			<fileset dir="${sourceDir}" includes="**/*.properties" />
			<fileset dir="${buildDir}" includes="**/*.class" />
			<fileset dir="${libDir}" includes="**/*.class" />
			<fileset dir="c:/winnt/java/classes" includes="org/apache/**/*, org/xml/**/*, org/w3c/**/*" />
		</jar>
	</target>
	
	<!-- generate javadoc documentation -->
	<target name="javadoc">
		<javadoc	locale="en_US"
					packagenames="com.sun.msv.*"
					sourcepath="${sourceDir}"
					classpath="lib/dispatcher;${java.class.path}"
					destdir="${documentDir}"
					windowtitle="Sun Multi Schema Validator"
					public="yes"
					author="yes"
					>
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api" packagelistLoc="ExternalPackageLists\CoreAPI" />
			<link offline="true" href="http://xml.apache.org/apiDocs/" packagelistLoc="ExternalPackageLists\XML" />
			<link offline="true" href="http://iso-relax.sourceforge.net/apiDoc/" packagelistLoc="ExternalPackageLists\ISO-RELAX" />
		</javadoc>
	</target>
	
	
	
	
	
<!--
	release task
	************************************************
-->
	
	<!-- generate XSDLib release -->
	<target name="xsd">
		<tstamp />
		<property name="stageName" value="xsdlib-${DSTAMP}"/>
		
		<delete	dir="${stageName}" />
		<mkdir	dir="${stageName}" />
		<mkdir	dir="${stageName}/src" />
		<mkdir	dir="${stageName}/src/com/sun/msv/datatype" />
		<mkdir	dir="${stageName}/src/com/sun/xml" />
		
		<!-- obtain source codes from cvs -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/test/com/sun/msv/datatype/CommandLineTester.java"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}/src/com/sun/msv/datatype" />
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/src/com/sun/msv/datatype"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}/src/com/sun/msv/datatype" />
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/src/com/sun/xml"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}/src/com/sun/xml" />
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/relaxng"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}/src/" />

		<!-- copy Xerces files into source directory -->
		<copy todir="${stageName}/src">
			<fileset dir="C:\Program Files\Development\Xerces\src" includes="org/apache/xerces/utils/regex/*.*" />
		</copy>
		
		<!-- obtain document files -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/doc/datatype"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}" />
				
		<!-- run javacc -->
		<antcall target="doJavacc">
			<param name="src" value="${stageName}/src" />
		</antcall>
		
		
		<!-- compile files -->
		<mkdir	dir="temp" />
		<javac	srcdir="${stageName}/src"
				destdir="temp">
			<include name="**/*.java" />
		</javac>
		
		<!-- create a time stamp file -->
		<echo file="temp/version.properties">version=${DSTAMP}</echo>
		
		<!-- creates binary jar -->
		<jar	jarfile="${stageName}/xsdlib.jar"
				manifest="./META-INF/XSD.MANIFEST.MF"
				compress="false">
			<fileset dir="temp" />
			<!-- resource files -->
			<fileset dir="${stageName}/src" includes="**/*.properties" />
		</jar>
		<delete dir="temp" />
		
		
		<!-- creates javadoc -->
		<mkdir		dir="${stageName}/javadoc" />
		<javadoc	locale="en_US"
					packagenames="com.sun.msv.datatype.*"
					sourcepath="${stageName}/src"
					destdir="${stageName}/javadoc"
					windowtitle="XML Schema Part 2 Implementation"
					public="yes"
					author="yes"
					>
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api" packagelistLoc="ExternalPackageLists\CoreAPI" />
			<link offline="true" href="http://xml.apache.org/apiDocs/" packagelistLoc="ExternalPackageLists\XML" />
		</javadoc>

		<!-- delete the source! -->		
		<delete>
			<fileset dir="${stageName}/src" excludes="**/CommandLineTester.java" />
		</delete>

		<!-- creates distribution package -->
		<zip	zipfile="${packageDir}/xsdlib.${DSTAMP}.zip"
				basedir="."
				includes="${stageName}/**/*.*" />
		
		<delete	dir="${stageName}" />
	</target>
	
	
	
	
	<!-- generate Tranquilo release -->
	<target name="release">
		<tstamp />
		<property name="stageName" value="msv-${DSTAMP}" />
		
		<delete	dir="${stageName}" />
		<mkdir	dir="${stageName}" />
		<mkdir	dir="${stageName}/src" />

		<!-- obtain source codes from cvs -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/src"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}/src/" />

		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/relaxng"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}/src/" />
		
		<!-- obtain document files -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/doc/tranquilo"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}" />
	
		<!-- run javacc -->
		<antcall target="doJavacc">
			<param name="src" value="${stageName}/src" />
		</antcall>
		
		<!-- unzip contents from iso-relax.jar into binary directory -->
		<!-- for ease of use, iso-relax.jar is merged into msv.jar -->
		<unjar src="${libDir}/iso-relax.jar" dest="temp" />
		
		<!-- compile files -->
		<mkdir	dir="temp" />
		<javac	srcdir="${stageName}/src"
				destdir="temp"
				classpath="temp;${java.class.path}">
			<include name="**/*.java" />
		</javac>
		
		<!-- unzip contents from xerces.jar -->
		<mkdir dir="xerces" />
		<unjar src="c:\winnt\java\classes\xerces.jar" dest="xerces" />
		
		<!-- create a time stamp file -->
		<echo file="temp/version.properties">version=${DSTAMP}</echo>
		
		<!-- creates binary jar -->
		<jar	jarfile="${stageName}/msv.jar"
				manifest="./META-INF/MANIFEST.MF"
				compress="false">
			<fileset dir="${stageName}/src" includes="**/msv/**/*.properties" />
			<fileset dir="${libDir}" includes="javax/xml/parsers/*.class" />
			<fileset dir="temp" />
			<fileset dir="xerces" includes="org/apache/xerces/**/*.*" />
<!--			<fileset dir="c:\winnt\java\classes" includes="org/apache/xerces/utils/regex/*.*" />	-->
			<fileset dir="c:\winnt\java\classes" includes="org/xml/sax/**/*.class org/w3c/dom/**/*.class" />
		</jar>
		
		<!-- creates javadoc -->
		<mkdir		dir="${stageName}/javadoc" />
		<javadoc	locale="en_US"
					packagenames="com.sun.msv.*"
					sourcepath="${stageName}/src"
					classpath="temp;${java.class.path}"
					destdir="${stageName}/javadoc"
					windowtitle="Sun Multi Schema Validator"
					author="yes"
					public="yes"
					>
			<!--
				if you have encountered error around here,
				please remove all offline="true" and packagelistLoc="...".
			-->
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api" packagelistLoc="ExternalPackageLists\CoreAPI" />
			<link offline="true" href="http://xml.apache.org/apiDocs/" packagelistLoc="ExternalPackageLists\XML" />
			<link offline="true" href="http://iso-relax.sourceforge.net/apiDoc/" packagelistLoc="ExternalPackageLists\ISO-RELAX" />
		</javadoc>
		<delete dir="${stageName}" includes="**/*.vsd">
			<!-- remove Visio files from release package -->
		</delete>

		<delete dir="temp" />
		<delete dir="xerces" />

		<!-- copy sample files -->
		<copy todir="${stageName}/examples">
			<fileset dir="${stageName}/src" includes="com/sun/msv/writer/trex/**/*.*" />
		</copy>
<!-- temporarily, remove source codes -->
		<delete dir="${stageName}/src" />
		
		
		<!-- creates distribution package -->
		<zip	zipfile="${packageDir}/msv.${DSTAMP}.zip"
				basedir="."
				includes="${stageName}/**/*.*" />
		
		<!-- copy jar file to package dir -->
		<copy file="${stageName}/msv.jar" tofile="./package/msv.jar" />
		
		<delete dir="${stageName}" />
	</target>
	
	
	
	
	
	
	
	<!-- generator release -->
	<target name="generator">
		<tstamp />
		<property name="stageName" value="xmlgen-${DSTAMP}"/>
		
		<delete	dir="${stageName}" />
		<mkdir	dir="${stageName}" />
		<mkdir	dir="${stageName}/src" />
		
		<!-- obtain source codes from cvs -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/generator"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}/src" />
				
		<!-- obtain document files -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/doc/generator"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}" />
		
		
		<!-- compile files -->
		<mkdir	dir="temp" />
		<javac	srcdir="${stageName}/src"
				destdir="temp"
				classpath="./package/msv.jar:${java.class.path}">
			<include name="**/*.java" />
		</javac>
		
		<!-- create a time stamp file -->
		<echo file="temp/version.properties">version=${DSTAMP}</echo>

		<!-- creates binary jar -->
		<jar	jarfile="${stageName}/xmlgen.small.jar"
				manifest="./META-INF/Generator.MANIFEST.MF"
				compress="false">
			<fileset dir="${stageName}/src" includes="**/*.properties" />
			<fileset dir="temp" includes="**/*.*" />
		</jar>
		
		
		<!-- unzip contents from xerces.jar -->
		<mkdir dir="xerces" />
		<unjar src="c:\winnt\java\classes\xerces.jar" dest="xerces" />
		
		<!-- unzip contents from msv.jar -->
		<unjar src="./package/msv.jar" dest="temp" />
		
		<!-- creates the complete binary jar -->
		<jar	jarfile="${stageName}/xmlgen.jar"
				manifest="./META-INF/Generator.MANIFEST.MF"
				compress="false">
			<fileset dir="${stageName}/src" includes="**/*.properties" />
			<fileset dir="xerces" includes="org/apache/xml/serialize/*.*" />
			<fileset dir="temp" includes="**/*.*" />
		</jar>
		<delete dir="temp" />
		<delete dir="xerces" />
		
		
		<!-- creates javadoc -->
		<mkdir		dir="${stageName}/javadoc" />
		<javadoc	locale="en_US"
					packagenames="com.sun.msv.generator.*"
					sourcepath="${stageName}/src"
					destdir="${stageName}/javadoc"
					windowtitle="Sun XML Generator"
					public="yes"
					author="yes"
					>
			<link offline="true" href="http://java.sun.com/products/jdk/1.2/docs/api" packagelistLoc="ExternalPackageLists\CoreAPI" />
			<link offline="true" href="http://xml.apache.org/apiDocs/" packagelistLoc="ExternalPackageLists\XML" />
		</javadoc>

		
<!-- temporarily, remove source codes -->
		<delete dir="${stageName}/src" />
		
		<!-- creates distribution package -->
		<zip	zipfile="${packageDir}/xmlgen.${DSTAMP}.zip"
				basedir="."
				includes="${stageName}/**/*.*" />
		
		<delete	dir="${stageName}" />
	</target>





	<!-- RELAX NG converter release -->
	<target name="rngconverter">
		<tstamp />
		<property name="stageName" value="rngconv-${DSTAMP}"/>
		
		<delete	dir="${stageName}" />
		<mkdir	dir="${stageName}" />
		<mkdir	dir="${stageName}/src" />
		
		<!-- obtain source codes from cvs -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/rngconverter"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}/src" />
				
		<!-- obtain document files -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/doc/rngconverter"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}" />
		
		
		<!-- compile files -->
		<mkdir	dir="temp" />
		<javac	srcdir="${stageName}/src"
				destdir="temp"
				classpath="./package/msv.jar:${java.class.path}">
			<include name="**/*.java" />
		</javac>
		
		<!-- create a time stamp file -->
		<echo file="temp/version.properties">version=${DSTAMP}</echo>


		<!-- creates binary jar -->
		<jar	jarfile="${stageName}/rngconv.small.jar"
				manifest="./META-INF/rngconv.MANIFEST.MF"
				compress="false">
			<fileset dir="${stageName}/src" includes="**/*.properties" />
			<fileset dir="temp" includes="**/*.*" />
		</jar>
		
		
		<!-- unzip contents from xerces.jar -->
		<mkdir dir="xerces" />
		<unjar src="c:\winnt\java\classes\xerces.jar" dest="xerces" />

		<!-- unzip contents from msv.jar -->
		<unjar src="./package/msv.jar" dest="temp" />
		
		<!-- creates the complete binary jar -->
		<jar	jarfile="${stageName}/rngconv.jar"
				manifest="./META-INF/rngconv.MANIFEST.MF"
				compress="false">
			<fileset dir="${stageName}/src" includes="**/*.properties" />
			<fileset dir="temp" includes="**/*.*" />
			<fileset dir="xerces" includes="org/apache/xml/serialize/*.*" />
		</jar>
		<delete dir="temp" />
		<delete dir="xerces" />
		
		<!-- we don't create javadoc for rngconv -->

<!-- temporarily, remove source codes -->
		<delete dir="${stageName}/src" />
		
		<!-- creates distribution package -->
		<zip	zipfile="${packageDir}/rngconv.${DSTAMP}.zip"
				basedir="."
				includes="${stageName}/**/*.*" />
		
		<delete	dir="${stageName}" />
	</target>







	<!-- TREX converter release -->
	<target name="trexconverter">
		<tstamp />
		<property name="stageName" value="trexconv-${DSTAMP}"/>
		
		<delete	dir="${stageName}" />
		<mkdir	dir="${stageName}" />
		<mkdir	dir="${stageName}/src" />
		
		<!-- obtain source codes from cvs -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/trexconverter"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}/src" />
				
		<!-- obtain document files -->
		<cvs	cvsRoot="${cvsRoot}"
				package="tranquilo/doc/trexconverter"
				command="export -d . ${cvsExportOpt}"
				dest="${stageName}" />
		
		
		<!-- compile files -->
		<mkdir	dir="temp" />
		<javac	srcdir="${stageName}/src"
				destdir="temp"
				classpath="./package/msv.jar:${java.class.path}">
			<include name="**/*.java" />
		</javac>
		
		<!-- create a time stamp file -->
		<echo file="temp/version.properties">version=${DSTAMP}</echo>


		<!-- creates binary jar -->
		<jar	jarfile="${stageName}/trexconv.small.jar"
				manifest="./META-INF/trexconv.MANIFEST.MF"
				compress="false">
			<fileset dir="${stageName}/src" includes="**/*.properties" />
			<fileset dir="temp" includes="**/*.*" />
		</jar>
		
		
		<!-- unzip contents from xerces.jar -->
		<mkdir dir="xerces" />
		<unjar src="c:\winnt\java\classes\xerces.jar" dest="xerces" />

		<!-- unzip contents from msv.jar -->
		<unjar src="./package/msv.jar" dest="temp" />
		
		<!-- creates the complete binary jar -->
		<jar	jarfile="${stageName}/trexconv.jar"
				manifest="./META-INF/trexconv.MANIFEST.MF"
				compress="false">
			<fileset dir="${stageName}/src" includes="**/*.properties" />
			<fileset dir="temp" includes="**/*.*" />
			<fileset dir="xerces" includes="org/apache/xml/serialize/*.*" />
		</jar>
		<delete dir="temp" />
		<delete dir="xerces" />
		
		<!-- we don't create javadoc for rngconv -->

<!-- temporarily, remove source codes -->
		<delete dir="${stageName}/src" />
		
		<!-- creates distribution package -->
		<zip	zipfile="${packageDir}/trexconv.${DSTAMP}.zip"
				basedir="."
				includes="${stageName}/**/*.*" />
		
		<delete	dir="${stageName}" />
	</target>



</project>
